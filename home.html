<!DOCTYPE html>
<html>

<head>
  <!--Import Google Icon Font-->
  <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
  <!--Import materialize.css-->
  <link type="text/css" rel="stylesheet" href="style/materialize.min.css" media="screen,projection" />

  <!--Let browser know website is optimized for mobile-->
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <style>
    .btr {
      margin: 0.3rem;
      border-radius: 1rem;
    }
  </style>
</head>
<nav class="nav-extended">

  <div class="nav-wrapper  transparent">
    <a href="#" class="brand-logo center"><img src="./img/login.png" style="height: 5rem;"></a>
    <a href="#" data-target="slide-out" class="sidenav-trigger"><i class="material-icons"
        style="margin-left: 1rem;">menu</i></a>

  </div>



</nav>

<ul id="slide-out" class="sidenav">
  <li>
    <div class="user-view">
      <div class="background">
        <img
          src="https://encrypted-tbn0.gstatic.com/images?q=tbn:ANd9GcRLomIu3fQjJQUuITBpfSX2sW_3dp6PIBO6x-WwxLLPUnj0ztzpC0oQpmdNzQ&s=10">
      </div>
      <a href="#user"><img
          src="https://encrypted-tbn0.gstatic.com/images?q=tbn%3AANd9GcTsMQENMLWJ0IEemXMQDtldtqWLv5Qcu-HCQz2WGQTYq9WKxA8T&usqp=CAU"
          alt=""></a>
      <a href="#name"><span class="white-text name">John Doe</span></a>
      <a href="#email"><span class="white-text email">jdandturk@gmail.com</span></a>
    </div>
  </li>
  <li><a href="#!" class="waves-effect"><i class="material-icons">cloud</i>Trending Rants</a></li>
  <li><a href="#!" class="waves-effect"><i class="material-icons">play_arrow</i>Personal Rants</a></li>
  <li><a href="#!" class="waves-effect"><i class="material-icons">account_circle</i>Profile</a></li>
  <li>
    <div class="divider"></div>
  </li>

  <li><a class="waves-effect" href="#!"><i class="material-icons">settings</i>Settings</a></li>
</ul>



<body class="indigo lighten-5">
  <section class="container" style="margin-top: 15%;">
    <div class="row center-align">
      <h3>Welcome <br> <span class="red-text accent-2" style="font-size: 2rem;"> Kromate</span></h3>
    </div>

    <div class="row center-align" style="margin-top: 8rem;">
      <button id="record" class="circle btn-floating btn-large red accent-1 responsive-img waves-light waves-effect">
        <img src="./img/vintage.png" class="circle responsive-img ">
      </button>
      <p class="purple-text lighten-4">Click the icon to start ranting</p>

      <section id="sound-clips"></section>
      <button class="btr waves-effect waves-light btn" id="pause"><i class="material-icons left">pause</i>pause</button>
      <br>
      <button class="btr waves-effect waves-light btn" id="stop"><i class="material-icons left">stop</i>stop</button>

    </div>


  </section>





  <!--JavaScript at end of body for optimized loading-->
  <script>


    const record = document.querySelector('#record');
    const pause = document.querySelector('#pause');
    const stop = document.querySelector('#stop');
    const soundClips = document.querySelector('#sound-clips');
    const canvas = document.querySelector('#visualizer');
    const mainSection = document.querySelector('#main-controls');

    // disable stop button while not recording
    stop.disabled = true;
    pause.disabled = true;


    // visualiser setup - create web audio api context and canvas Not done yet.

    // const audioCtx = new (window.AudioContext || webkitAudioContext)();
    // const canvasCtx = canvas.getContext("2d");

    //main block for doing the audio recording

    if (navigator.mediaDevices.getUserMedia) {
      console.log('getUserMedia supported.');

      let chunks = [];

      const onSuccess = (stream) => {

        const mediaRecorder = new MediaRecorder(stream);

        record.onclick = function () {
          if (mediaRecorder.state == 'inactive') {
            mediaRecorder.start();
            stop.disabled = false;
            record.disabled = true;
            pause.disabled = false;
          } else {
            mediaRecorder.resume();
            stop.disabled = false;
            record.disabled = true;
            pause.disabled = false;
          }


        }

        pause.onclick = function () {
          mediaRecorder.pause();
          stop.disabled = false;
          record.disabled = false;
          pause.disabled = true;

        }

        stop.onclick = function () {
          mediaRecorder.stop();
          stop.disabled = true;
          record.disabled = false;
          pause.disabled = true;

        }

        mediaRecorder.onstop = function (e) {
          let clipContainer = document.createElement('article');
          let audio = document.createElement('audio');
          let deleteButton = document.createElement('button');
          let saveButton = document.createElement('button')
          let uploadButton = document.createElement('upload')

          clipContainer.classList.add('clip');
          audio.setAttribute('controls', '');
          deleteButton.textContent = 'Delete';
          deleteButton.className = 'delete btr waves-effect waves-light btn';
          saveButton.textContent = 'Save ';
          saveButton.className = 'save btr waves-effect waves-light btn';
          uploadButton.textContent = 'Upload';
          uploadButton.className = 'save btr waves-effect waves-light btn';

          clipContainer.appendChild(audio);
          clipContainer.appendChild(deleteButton);
          clipContainer.appendChild(uploadButton);
          clipContainer.appendChild(saveButton)
          soundClips.appendChild(clipContainer);

          audio.controls = true;
          let blob = new Blob(chunks, { 'type': 'audio/mpeg; codecs=opus' });
          chunks = [];
          let audioURL = window.URL.createObjectURL(blob);
          audio.src = audioURL;
          console.log("recorder stopped");

          deleteButton.onclick = (e) => {
            evtTgt = e.target;
            evtTgt.parentNode.parentNode.removeChild(evtTgt.parentNode);
          }

          saveButton.onclick = (e) => {
            console.log(blob)
            alert(`Save sends this ${blob.size}-bit audio blob to server`)
          }
        }

        mediaRecorder.ondataavailable = function (e) {
          chunks.push(e.data);
        }
      } // onSuccess

      const onError = (err) => {
        console.log('The following error occured: ' + err);
      }

      navigator.mediaDevices.getUserMedia({ audio: true }).then(onSuccess, onError);

    } else {
      console.log('getUserMedia not supported on your browser!');
    }
  </script>
  <script type="text/javascript" src="js/materialize.min.js"></script>
  <script>
    M.AutoInit();
  </script>
</body>

</html>